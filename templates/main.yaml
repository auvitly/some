name: types
main: |-
  {{- "test/main.go" | go.AST.P.Files | go.AST.I.Decl.Gen.Tok "type" | go.AST.I.Spec.Types | v.Set "pipe" | void }}

  {{- define "stage-1" }}
    {{- must.Type "[]*ast.TypeSpec" . | void }}
    {{- $list := obj.List (len .) }}
    {{- $list | obj.Set "Name" (. | go.AST.I.Spec.Type.Names | go.AST.I.Expr.Ident.Names) | void }}
    {{- $list | obj.Set "Spec" (. | go.AST.I.Spec.Types) | void }}
    {{- $list | v.Set "pipe" | void }}
  {{- end }}

  {{- define "stage-2" }}
    {{- range $i, $item := (. | must.Type "obj.List")}}
      {{- $item | obj.Set "Spec" $item.Spec.Type | void }}
      {{- template "TypeSwitch" $item }}
    {{- end }}
  {{- end }}

  {{- define "TypeSwitch" }} 
    {{- $item := . | must.Type "obj.Item" }}
    {{- $item | must.NotNil | void }}

    {{- if      $item.Spec | type.Of | eq "*ast.Ident"}}       {{- $item | obj.Set "Spec" $item.Spec.Name | void }}
    {{- else if $item.Spec | type.Of | eq "*ast.StarExpr"}}    {{- $item | obj.Del "Spec" | void }}
    {{- else if $item.Spec | type.Of | eq "*ast.SelectorExpr"}}{{- $item | obj.Del "Spec" | void }}
    {{- else if $item.Spec | type.Of | eq "*ast.ChanType"}}    {{- $item | obj.Del "Spec" | void }}
    {{- else if $item.Spec | type.Of | eq "*ast.MapType"}}     {{- $item | obj.Del "Spec" | void }}
    {{- else if $item.Spec | type.Of | eq "*ast.ArrayType"}}   {{- template "TypeSwitch.ArrayType" $item }}
    {{- else if $item.Spec | type.Of | eq "*ast.StructType"}}  {{- $item | obj.Del "Spec" | void }}
    {{- else }}                                                {{- $item | obj.Del "Spec" | void }}
    {{- end }}
  {{- end }}

  {{- define "TypeSwitch.Ident" }}
    {{- .     | must.Type "obj.Item"   | void }}
    {{- .Spec | must.Type "*ast.Ident" | void }}
  {{- end }}

  {{- define "TypeSwitch.ArrayType" }}
    {{- .     | must.Type "obj.Item"       | void }}
    {{- .Spec | must.Type "*ast.ArrayType" | void }}
    {{- if eq .Len null }} 
      {{- . | obj.Set "Type" "slice"   | void }} 
      {{- . | obj.Set "Spec" (obj.Item | obj.Set "Spec" .Spec.Elt ) | void }}
      {{- template "TypeSwitch" .Spec }}
    {{- else }}
      {{- . | obj.Set "Type" "array"   | void }}
      {{- . | obj.Set "Len" (.Spec.Len | go.AST.I.Expr.BasicLit.Values | index 0) | void }}
      {{- . | obj.Set "Spec" (obj.Item | obj.Set "Spec" .Spec.Elt ) | void }}
      {{- template "TypeSwitch" .Spec }}
    {{- end }}
  {{- end }}

  {{- template "stage-1" (v.Get "pipe") }}
  {{- template "stage-2" (v.Get "pipe") }}

  {{- v.Get "pipe" | dump | os.OW "dump/main.log" | void }}
